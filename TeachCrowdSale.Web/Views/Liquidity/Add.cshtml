@model TeachCrowdSale.Core.Models.Liquidity.AddLiquidityModel?
@{
    Layout = null;
}
@{
    ViewData["Title"] = "Add Liquidity - TEACH Token Liquidity Wizard";
    ViewData["Description"] = "Step-by-step wizard to add liquidity to TEACH token pools. Connect wallet, select pools, and earn rewards.";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <meta name="description" content="@ViewData["Description"]" />

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Add Liquidity - TEACH Token Wizard" />
    <meta property="og:description" content="@ViewData["Description"]" />
    <meta property="og:image" content="/images/teachtoken-add-liquidity-og.jpg" />
    <meta property="og:url" content="https://teachtoken.io/liquidity/add" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Add Liquidity - TEACH Token Wizard" />
    <meta name="twitter:description" content="@ViewData["Description"]" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Syncfusion CSS -->
    <link href="https://cdn.syncfusion.com/ej2/material3-dark.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/liquidity.css" asp-append-version="true" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
</head>

<body>
    <!-- Navigation -->
    @await Html.PartialAsync("_NavigationPartial")

    <!-- Main Content Wrapper -->
    <div class="main-content">

        <!-- Wizard Hero Section -->
        <section class="liquidity-hero-section">
            <div class="container">
                <div class="wizard-container">
                    <div class="liquidity-hero-content">
                        <h1>Add Liquidity</h1>
                        <p class="liquidity-hero-subtitle">
                            Follow our step-by-step wizard to safely add liquidity to TEACH token pools and start earning rewards.
                        </p>
                    </div>

                    <!-- Wizard Progress Indicator -->
                    <div class="wizard-progress" id="wizard-progress">
                        <div class="wizard-progress-fill" id="progress-fill"></div>

                        <div class="wizard-step" data-step="1">
                            <div class="step-circle active" id="step-circle-1">1</div>
                            <span class="step-label">Connect Wallet</span>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="step-circle" id="step-circle-2">2</div>
                            <span class="step-label">Select Pool</span>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <div class="step-circle" id="step-circle-3">3</div>
                            <span class="step-label">Choose DEX</span>
                        </div>
                        <div class="wizard-step" data-step="4">
                            <div class="step-circle" id="step-circle-4">4</div>
                            <span class="step-label">Enter Amounts</span>
                        </div>
                        <div class="wizard-step" data-step="5">
                            <div class="step-circle" id="step-circle-5">5</div>
                            <span class="step-label">Review & Confirm</span>
                        </div>
                    </div>

                    <!-- Wizard Content Container -->
                    <div class="wizard-content" id="wizard-content">

                        <!-- Step 1: Connect Wallet -->
                        <div class="wizard-step-content active" data-step="1">
                            <h2>Connect Your Wallet</h2>
                            <p>Connect your crypto wallet to add liquidity to TEACH token pools.</p>

                            <div class="wallet-connect" id="wallet-connect">
                                <h3>Choose Your Wallet</h3>
                                <p>Select a wallet to connect and manage your liquidity positions.</p>

                                <div class="wallet-options">
                                    <button class="wallet-option" data-wallet="metamask">
                                        <img src="/images/wallets/metamask.png" alt="MetaMask" class="wallet-icon">
                                        <span>MetaMask</span>
                                    </button>
                                    <button class="wallet-option" data-wallet="walletconnect">
                                        <img src="/images/wallets/walletconnect.png" alt="WalletConnect" class="wallet-icon">
                                        <span>WalletConnect</span>
                                    </button>
                                    <button class="wallet-option" data-wallet="coinbase">
                                        <img src="/images/wallets/coinbase.png" alt="Coinbase Wallet" class="wallet-icon">
                                        <span>Coinbase Wallet</span>
                                    </button>
                                    <button class="wallet-option" data-wallet="trust">
                                        <img src="/images/wallets/trust.png" alt="Trust Wallet" class="wallet-icon">
                                        <span>Trust Wallet</span>
                                    </button>
                                </div>

                                <div class="wallet-status" id="wallet-status" style="display: none;">
                                    <div class="wallet-connected">
                                        <h4>✅ Wallet Connected</h4>
                                        <p>Address: <span id="wallet-address"></span></p>
                                        <p>Balance: <span id="wallet-balance"></span> ETH</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Select Pool -->
                        <div class="wizard-step-content" data-step="2">
                            <h2>Select Liquidity Pool</h2>
                            <p>Choose a pool to provide liquidity to. Compare APY, risk level, and requirements.</p>

                            <div class="pool-selection">
                                <div class="pool-search">
                                    <input type="text" id="pool-search-wizard" placeholder="Search pools...">
                                </div>

                                <div class="pool-comparison-table">
                                    <table class="comparison-table">
                                        <thead>
                                            <tr>
                                                <th>Select</th>
                                                <th>Pool</th>
                                                <th>DEX</th>
                                                <th>APY</th>
                                                <th>TVL</th>
                                                <th>Risk</th>
                                                <th>Min. Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pool-comparison-body">
                                            @if (Model?.AvailablePools != null && Model.AvailablePools.Any())
                                            {
                                                @foreach (var pool in Model.AvailablePools)
                                                {
                                                    <tr class="pool-comparison-row" data-pool-id="@pool.Id">
                                                        <td>
                                                            <input type="radio" name="selected-pool" value="@pool.Id" id="pool-@pool.Id">
                                                        </td>
                                                        <td>
                                                            <div class="pool-cell">
                                                                <div class="token-pair-small">
                                                                    <img src="@pool.Token1Icon" alt="@pool.Token1Symbol" class="token-icon-small">
                                                                    <img src="@pool.Token2Icon" alt="@pool.Token2Symbol" class="token-icon-small">
                                                                </div>
                                                                <span>@pool.Token1Symbol/@pool.Token2Symbol</span>
                                                            </div>
                                                        </td>
                                                        <td><span class="dex-badge-small">@pool.DexName</span></td>
                                                        <td><span class="apy-cell">@pool.Apy.ToString("F2")%</span></td>
                                                        <td>$@pool.TotalValueLocked.ToString("N0")</td>
                                                        <td>
                                                            <span class="risk-badge risk-@pool.RiskLevel.ToLower()">
                                                                @pool.RiskLevel
                                                            </span>
                                                        </td>
                                                        <td>$@pool.MinimumAmount.ToString("N0")</td>
                                                    </tr>
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>

                                <div class="selected-pool-details" id="selected-pool-details" style="display: none;">
                                    <h4>Selected Pool Details</h4>
                                    <div class="pool-detail-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Pool:</span>
                                            <span class="detail-value" id="selected-pool-name"></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">APY:</span>
                                            <span class="detail-value" id="selected-pool-apy"></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Fee Tier:</span>
                                            <span class="detail-value" id="selected-pool-fee"></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Risk Level:</span>
                                            <span class="detail-value" id="selected-pool-risk"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Choose DEX -->
                        <div class="wizard-step-content" data-step="3">
                            <h2>Choose DEX Platform</h2>
                            <p>Select the decentralized exchange where you want to provide liquidity.</p>

                            <div class="dex-selection">
                                <div class="dex-options-grid" id="dex-options-grid">
                                    @if (Model?.DexOptions != null && Model.DexOptions.Any())
                                    {
                                        @foreach (var dex in Model.DexOptions)
                                        {
                                            <div class="dex-option-card" data-dex-id="@dex.Id">
                                                <input type="radio" name="selected-dex" value="@dex.Id" id="dex-@dex.Id" style="display: none;">
                                                <label for="dex-@dex.Id" class="dex-card-label">
                                                    <div class="dex-header">
                                                        <img src="@dex.LogoUrl" alt="@dex.Name" class="dex-logo">
                                                        <h3>@dex.Name</h3>
                                                        @if (dex.IsRecommended)
                                                        {
                                                            <span class="recommended-badge">Recommended</span>
                                                        }
                                                    </div>

                                                    <div class="dex-stats">
                                                        <div class="dex-stat">
                                                            <span class="stat-label">Pool APY</span>
                                                            <span class="stat-value">@dex.PoolApy.ToString("F2")%</span>
                                                        </div>
                                                        <div class="dex-stat">
                                                            <span class="stat-label">Gas Fees</span>
                                                            <span class="stat-value gas-@dex.GasFeeLevel.ToLower()">@dex.GasFeeLevel</span>
                                                        </div>
                                                        <div class="dex-stat">
                                                            <span class="stat-label">TVL</span>
                                                            <span class="stat-value">$@dex.TotalValueLocked.ToString("N0")</span>
                                                        </div>
                                                    </div>

                                                    <div class="dex-features">
                                                        @foreach (var feature in dex.Features)
                                                        {
                                                            <span class="feature-tag">@feature</span>
                                                        }
                                                    </div>

                                                    <div class="dex-description">
                                                        <p>@dex.Description</p>
                                                    </div>
                                                </label>
                                            </div>
                                        }
                                    }
                                </div>

                                <div class="dex-comparison" id="dex-comparison" style="display: none;">
                                    <h4>Platform Comparison</h4>
                                    <div class="comparison-metrics">
                                        <div class="metric">
                                            <span class="metric-label">Security Audit</span>
                                            <span class="metric-value" id="selected-dex-security"></span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-label">User Rating</span>
                                            <span class="metric-value" id="selected-dex-rating"></span>
                                        </div>
                                        <div class="metric">
                                            <span class="metric-label">Avg. Transaction Time</span>
                                            <span class="metric-value" id="selected-dex-speed"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Enter Amounts -->
                        <div class="wizard-step-content" data-step="4">
                            <h2>Enter Liquidity Amounts</h2>
                            <p>Specify how much of each token you want to provide as liquidity.</p>

                            <div class="amount-input-section">
                                <div class="token-inputs-grid">
                                    <!-- Token 1 Input -->
                                    <div class="token-input-card">
                                        <div class="token-input-header">
                                            <div class="token-info">
                                                <img src="" alt="" class="token-icon" id="token1-icon">
                                                <span class="token-symbol" id="token1-symbol">TEACH</span>
                                            </div>
                                            <div class="token-balance">
                                                Balance: <span id="token1-balance">0.00</span>
                                            </div>
                                        </div>
                                        <div class="token-input-body">
                                            <input type="number" id="token1-amount" placeholder="0.00" class="amount-input">
                                            <div class="amount-buttons">
                                                <button class="amount-btn" data-percentage="25">25%</button>
                                                <button class="amount-btn" data-percentage="50">50%</button>
                                                <button class="amount-btn" data-percentage="75">75%</button>
                                                <button class="amount-btn" data-percentage="100">MAX</button>
                                            </div>
                                        </div>
                                        <div class="token-input-footer">
                                            <span class="usd-value" id="token1-usd">$0.00</span>
                                        </div>
                                    </div>

                                    <!-- Plus Icon -->
                                    <div class="input-separator">
                                        <div class="plus-icon">+</div>
                                    </div>

                                    <!-- Token 2 Input -->
                                    <div class="token-input-card">
                                        <div class="token-input-header">
                                            <div class="token-info">
                                                <img src="" alt="" class="token-icon" id="token2-icon">
                                                <span class="token-symbol" id="token2-symbol">ETH</span>
                                            </div>
                                            <div class="token-balance">
                                                Balance: <span id="token2-balance">0.00</span>
                                            </div>
                                        </div>
                                        <div class="token-input-body">
                                            <input type="number" id="token2-amount" placeholder="0.00" class="amount-input">
                                            <div class="amount-buttons">
                                                <button class="amount-btn" data-percentage="25">25%</button>
                                                <button class="amount-btn" data-percentage="50">50%</button>
                                                <button class="amount-btn" data-percentage="75">75%</button>
                                                <button class="amount-btn" data-percentage="100">MAX</button>
                                            </div>
                                        </div>
                                        <div class="token-input-footer">
                                            <span class="usd-value" id="token2-usd">$0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pool Share Calculator -->
                                <div class="pool-calculator">
                                    <h4>Pool Position Preview</h4>
                                    <div class="calculator-grid">
                                        <div class="calc-item">
                                            <span class="calc-label">Total Deposit Value</span>
                                            <span class="calc-value" id="total-deposit-value">$0.00</span>
                                        </div>
                                        <div class="calc-item">
                                            <span class="calc-label">Pool Share</span>
                                            <span class="calc-value" id="pool-share">0.00%</span>
                                        </div>
                                        <div class="calc-item">
                                            <span class="calc-label">LP Tokens Received</span>
                                            <span class="calc-value" id="lp-tokens">0.00</span>
                                        </div>
                                        <div class="calc-item">
                                            <span class="calc-label">Estimated Daily Earnings</span>
                                            <span class="calc-value" id="daily-earnings">$0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Impermanent Loss Warning -->
                                <div class="impermanent-loss-warning">
                                    <div class="warning-header">
                                        <span class="warning-icon">⚠️</span>
                                        <h4>Impermanent Loss Risk</h4>
                                    </div>
                                    <div class="warning-content">
                                        <p>Your tokens may be worth less when you withdraw compared to holding them separately if their prices diverge significantly.</p>
                                        <div class="il-calculator">
                                            <span class="il-label">Estimated IL at price changes:</span>
                                            <div class="il-scenarios">
                                                <div class="il-scenario">
                                                    <span>+25% price diff:</span>
                                                    <span class="il-value">-0.6%</span>
                                                </div>
                                                <div class="il-scenario">
                                                    <span>+50% price diff:</span>
                                                    <span class="il-value">-2.0%</span>
                                                </div>
                                                <div class="il-scenario">
                                                    <span>+100% price diff:</span>
                                                    <span class="il-value">-5.7%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="learn-more-btn" onclick="showImpermanentLossGuide()">
                                            Learn More About Impermanent Loss
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 5: Review & Confirm -->
                        <div class="wizard-step-content" data-step="5">
                            <h2>Review & Confirm</h2>
                            <p>Review your liquidity provision details before proceeding to the external DEX.</p>

                            <div class="review-section">
                                <!-- Transaction Summary -->
                                <div class="review-card">
                                    <h4>Transaction Summary</h4>
                                    <div class="review-grid">
                                        <div class="review-item">
                                            <span class="review-label">Pool</span>
                                            <span class="review-value" id="review-pool">TEACH/ETH</span>
                                        </div>
                                        <div class="review-item">
                                            <span class="review-label">DEX Platform</span>
                                            <span class="review-value" id="review-dex">Uniswap V3</span>
                                        </div>
                                        <div class="review-item">
                                            <span class="review-label">Token 1 Amount</span>
                                            <span class="review-value" id="review-token1">1,000 TEACH</span>
                                        </div>
                                        <div class="review-item">
                                            <span class="review-label">Token 2 Amount</span>
                                            <span class="review-value" id="review-token2">0.5 ETH</span>
                                        </div>
                                        <div class="review-item">
                                            <span class="review-label">Total Value</span>
                                            <span class="review-value" id="review-total">$1,250.00</span>
                                        </div>
                                        <div class="review-item">
                                            <span class="review-label">Expected APY</span>
                                            <span class="review-value" id="review-apy">12.5%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cost Breakdown -->
                                <div class="review-card">
                                    <h4>Cost Breakdown</h4>
                                    <div class="cost-breakdown">
                                        <div class="cost-item">
                                            <span class="cost-label">Estimated Gas Fees</span>
                                            <span class="cost-value" id="review-gas">~$25.00</span>
                                        </div>
                                        <div class="cost-item">
                                            <span class="cost-label">DEX Fee</span>
                                            <span class="cost-value" id="review-dex-fee">0.3%</span>
                                        </div>
                                        <div class="cost-item">
                                            <span class="cost-label">Slippage Tolerance</span>
                                            <span class="cost-value">
                                                <select id="slippage-tolerance">
                                                    <option value="0.1">0.1%</option>
                                                    <option value="0.5" selected>0.5%</option>
                                                    <option value="1.0">1.0%</option>
                                                    <option value="3.0">3.0%</option>
                                                </select>
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Risk Acknowledgment -->
                                <div class="review-card risk-acknowledgment">
                                    <h4>Risk Acknowledgment</h4>
                                    <div class="risk-checklist">
                                        <label class="risk-checkbox">
                                            <input type="checkbox" id="understand-il" required>
                                            <span class="checkmark"></span>
                                            I understand the risk of impermanent loss
                                        </label>
                                        <label class="risk-checkbox">
                                            <input type="checkbox" id="understand-gas" required>
                                            <span class="checkmark"></span>
                                            I understand gas fees may vary and are non-refundable
                                        </label>
                                        <label class="risk-checkbox">
                                            <input type="checkbox" id="understand-smart-contract" required>
                                            <span class="checkmark"></span>
                                            I understand smart contract risks and that this is not investment advice
                                        </label>
                                        <label class="risk-checkbox">
                                            <input type="checkbox" id="understand-external" required>
                                            <span class="checkmark"></span>
                                            I understand I will be redirected to an external DEX to complete the transaction
                                        </label>
                                    </div>
                                </div>

                                <!-- Final Actions -->
                                <div class="review-card final-actions">
                                    <h4>Ready to Proceed</h4>
                                    <p>You will be redirected to <span id="final-dex-name">Uniswap</span> to complete your liquidity provision. Make sure you have sufficient tokens and ETH for gas fees.</p>

                                    <div class="final-action-buttons">
                                        <button class="btn-secondary" onclick="openDexInfo()">
                                            View DEX Information
                                        </button>
                                        <button class="btn-primary" id="proceed-to-dex" onclick="proceedToDex()" disabled>
                                            Proceed to <span id="dex-name-btn">Uniswap</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Wizard Navigation -->
                    <div class="wizard-actions">
                        <button class="wizard-btn btn-secondary" id="prev-btn" onclick="previousStep()" disabled>
                            Previous
                        </button>
                        <div class="wizard-step-indicator">
                            Step <span id="current-step">1</span> of 5
                        </div>
                        <button class="wizard-btn btn-primary" id="next-btn" onclick="nextStep()" disabled>
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Footer -->
    @await Html.PartialAsync("_FooterPartial")

    <!-- Modals -->
    <!-- Impermanent Loss Guide Modal -->
    <div id="il-guide-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Understanding Impermanent Loss</h3>
                <button class="modal-close" onclick="closeModal('il-guide-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="il-guide-content">
                    <h4>What is Impermanent Loss?</h4>
                    <p>Impermanent loss occurs when the price ratio of your deposited tokens changes compared to when you deposited them. The bigger the change, the more you lose.</p>

                    <h4>Why does it happen?</h4>
                    <p>Automated market makers rebalance your tokens automatically. If one token gains value relative to the other, the AMM will sell some of the gaining token for the losing one.</p>

                    <h4>Example Scenario</h4>
                    <div class="il-example">
                        <div class="il-step">
                            <strong>Initial:</strong> You deposit $1000 worth of ETH and $1000 worth of TEACH
                        </div>
                        <div class="il-step">
                            <strong>Price Change:</strong> ETH doubles in price relative to TEACH
                        </div>
                        <div class="il-step">
                            <strong>Result:</strong> Your position is now worth ~$1,900 instead of $2,000 if you held tokens separately
                        </div>
                        <div class="il-step">
                            <strong>Impermanent Loss:</strong> ~5% (offset by trading fees earned)
                        </div>
                    </div>

                    <h4>Mitigation Strategies</h4>
                    <ul>
                        <li>Choose pairs with correlated price movements</li>
                        <li>Consider stablecoin pairs for lower risk</li>
                        <li>Factor in trading fees and rewards</li>
                        <li>Monitor and adjust positions regularly</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message Container -->
    <div id="error-message" class="error-toast" style="display: none;">
        <span id="error-text"></span>
        <button onclick="hideError()" class="error-close">&times;</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Processing...</p>
    </div>

    <!-- Syncfusion Scripts -->
    <script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js"></script>

    <!-- Custom Scripts -->
    <script src="~/js/add-liquidity.js" asp-append-version="true"></script>

    <!-- Initialize Wizard -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize wizard with server data
            const initialData = @Html.Raw(ViewBag.JsonData ?? "{}");
            const errorMessage = '@ViewBag.ErrorMessage';

            if (errorMessage) {
                showError(errorMessage);
            }

            if (window.AddLiquidityWizard) {
                window.AddLiquidityWizard.init(initialData);
            }
        });
    </script>
</body>
</html>